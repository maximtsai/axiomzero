let MESSAGE_BUS_CONSTANTS={INDEX_THRESHOLD:32767};class InternalMessageBus{constructor(){this.topics={},this.index=0}subscribe(t,s,o=null){if(t){if("function"!=typeof s)throw console.error("Topic "+t+" encountered error with callback: "),console.log(s),new Error("callback must be a function");this.topics.hasOwnProperty(t)||(this.topics[t]={});let e=this.index.toString();return this.topics[t][e]={callback:s,target:o},this.index++,this.index>MESSAGE_BUS_CONSTANTS.INDEX_THRESHOLD&&console.warn(`WARNING: Subscriber threshold reached for topic ${t}!`),{unsubscribe:()=>{delete this.topics[t][e],0===Object.keys(this.topics[t]).length&&delete this.topics[t]},topic:t}}console.error("Undefined subscription topic for callback: "),console.error(s)}subscribeOnce(e,t,s=null){let o=this.subscribe(e,function(...e){o.unsubscribe(),t.apply(s,e)});return o}publish(e,...i){if(this.topics.hasOwnProperty(e)){let s=this.topics[e],o=[];Object.keys(s).forEach(e=>{try{var t=s[e];t.callback.apply(t.target,i)}catch(e){o.push(e)}}),0<o.length&&o.forEach(e=>console.error(e))}}clearTopic(e){this.topics.hasOwnProperty(e)&&delete this.topics[e]}clearAll(){this.topics={},this.index=0}getSubscriberCount(e){return this.topics.hasOwnProperty(e)?Object.keys(this.topics[e]).length:0}hasSubscribers(e){return 0<this.getSubscriberCount(e)}getTopics(){return Object.keys(this.topics)}}let messageBus=new InternalMessageBus;function initDebug(i){if(FLAGS.DEBUG){let t=i.add.text(8,8,"",{fontFamily:"monospace",fontSize:14,color:"#00ff00",backgroundColor:"#00000088",padding:{x:4,y:2}}).setDepth(9999).setScrollFactor(0),s=i.add.rectangle(4,28,10,10,0,.72).setOrigin(0,0).setDepth(9998).setScrollFactor(0),o=i.add.text(8,32,"",{fontFamily:"monospace",fontSize:11,color:"#88ff88",lineSpacing:2}).setDepth(9999).setScrollFactor(0);updateManager.addFunction(()=>{t.setText("FPS "+Math.round(i.game.loop.actualFps));var e=Object.entries(GAME_VARS).map(([e,t])=>{let s;return e+": "+(s="number"==typeof t?Number.isInteger(t)?t:t.toFixed(3):null!==t&&"object"==typeof t?JSON.stringify(t):String(t))});o.setText(e.join("\n")),s.width=o.width+8,s.height=o.height+8}),debugLog("Debug mode enabled")}}class InternalMouseManager{setup(e){e.input.on("pointermove",e=>{GAME_VARS.mouseposx=e.x,GAME_VARS.mouseposy=e.y,GAME_VARS.wasTouch="touch"===e.pointerType,messageBus.publish("pointerMove",e.x,e.y)}),e.input.on("pointerdown",e=>{GAME_VARS.mouseposx=e.x,GAME_VARS.mouseposy=e.y,helper.createClickEffect(e.x,e.y),GAME_VARS.mousedown=!0,GAME_VARS.mouseJustDowned=!0,GAME_VARS.wasTouch="touch"===e.pointerType,GAME_VARS.lastmousedown.x=e.x,GAME_VARS.lastmousedown.y=e.y,messageBus.publish("pointerDown",e.x,e.y)}),e.input.on("pointerup",e=>{GAME_VARS.mouseposx=e.x,GAME_VARS.mouseposy=e.y,GAME_VARS.mousedown=!1,GAME_VARS.mouseJustUpped=!0,GAME_VARS.wasTouch="touch"===e.pointerType,messageBus.publish("pointerUp",e.x,e.y)})}}let mouseManager=new InternalMouseManager;function setupMouseInteraction(e){mouseManager.setup(e)}let AUDIO_CONSTANTS={LONG_SOUND_THRESHOLD:3.5,FADE_AWAY_DURATION:650,FADE_IN_DURATION:1e3,FADE_IN_DELAY:100,MUSIC_START_VOLUME:.1,DEFAULT_MUSIC_VOLUME:.85},soundList={},globalVolume=1,globalMusicVol=1,globalMusic=null,globalTempMusic=null,lastLongSound=null,lastLongSound2=null,useSecondLongSound=!1,isMuted=!1,isSFXMuted="true"===localStorage.getItem("sfxMuted"),isMusicMuted="true"===localStorage.getItem("musicMuted"),audio={recheckMuteState:function(){isSFXMuted="true"===localStorage.getItem("sfxMuted"),isMusicMuted="true"===localStorage.getItem("musicMuted")},muteAll:function(){isMuted=!0,globalMusic&&globalMusic.setVolume(0),globalTempMusic&&globalTempMusic.setVolume(0),lastLongSound&&lastLongSound.setVolume(0),lastLongSound2&&lastLongSound2.setVolume(0)},unmuteAll:function(){isMuted=!1,globalMusic&&(globalMusic.volume=globalMusic.fullVolume*globalMusicVol),globalTempMusic&&(globalTempMusic.volume=globalTempMusic.fullVolume*globalMusicVol),lastLongSound&&(lastLongSound.volume=lastLongSound.fullVolume*globalMusicVol),lastLongSound2&&(lastLongSound2.volume=lastLongSound2.fullVolume*globalMusicVol)},muteSFX:function(e){for(var t in isSFXMuted=e,localStorage.setItem("sfxMuted",e.toString()),soundList)!soundList[t].isMusic&&soundList[t].isPlaying&&soundList[t].setVolume(e?0:soundList[t].fullVolume*globalVolume)},muteMusic:function(e){isMusicMuted=e,localStorage.setItem("musicMuted",e.toString()),e?(globalMusic&&globalMusic.setVolume(0),globalTempMusic&&globalTempMusic.setVolume(0)):(globalMusic&&(globalMusic.volume=globalMusic.fullVolume*globalMusicVol),globalTempMusic&&(globalTempMusic.volume=globalTempMusic.fullVolume*globalMusicVol))},init:function(e){globalVolume=parseFloat(localStorage.getItem("globalVolume"))||1,globalMusicVol=parseFloat(localStorage.getItem("globalMusicVol"))||1,isSFXMuted="true"===localStorage.getItem("sfxMuted"),isMusicMuted="true"===localStorage.getItem("musicMuted")},play:function(e,t=1,s=!1,o=!1){return soundList[e]||(soundList[e]=PhaserScene.sound.add(e)),soundList[e].fullVolume=t,soundList[e].volume=soundList[e].fullVolume*globalVolume,soundList[e].loop=s,soundList[e].isMusic=o,soundList[e].currTween&&(soundList[e].currTween.stop(),soundList[e].currTween=null),o&&(globalMusic&&audio.fadeAway(globalMusic),(globalMusic=soundList[e]).volume=AUDIO_CONSTANTS.MUSIC_START_VOLUME*t*globalMusicVol,isMusicMuted||isMuted?globalMusic.volume=0:audio.fadeIn(globalMusic,t*globalMusicVol)),!o&&soundList[e].duration>AUDIO_CONSTANTS.LONG_SOUND_THRESHOLD&&(useSecondLongSound?lastLongSound2=soundList[e]:lastLongSound=soundList[e],useSecondLongSound=!useSecondLongSound),(isMuted||!o&&isSFXMuted||o&&isMusicMuted)&&(soundList[e].volume=0),soundList[e].detune=0,soundList[e].pan=0,soundList[e].play(),soundList[e]},playMusic:function(e,t=AUDIO_CONSTANTS.DEFAULT_MUSIC_VOLUME,s=!0){return audio.play(e,t,s,!0)},playFakeBGMusic:function(e,t=1,s=!1){return soundList[e]||(soundList[e]=PhaserScene.sound.add(e)),globalTempMusic=soundList[e],soundList[e].fullVolume=t,soundList[e].volume=soundList[e].fullVolume*globalMusicVol,soundList[e].loop=s,soundList[e].isMusic=!0,soundList[e].currTween&&(soundList[e].currTween.stop(),soundList[e].currTween=null),isMuted&&(soundList[e].volume=0),soundList[e].play(),soundList[e]},setVolume:function(e=1){for(var t in globalVolume=e,localStorage.setItem("globalVolume",e.toString()),soundList)soundList[t].isPlaying&&soundList[t]!==globalMusic&&(soundList[t].volume=soundList[t].fullVolume*globalVolume)},setMusicVolume:function(e=1){globalMusicVol=e,localStorage.setItem("globalMusicVol",e.toString()),globalMusic&&(globalMusic.volume=globalMusic.fullVolume*e),globalTempMusic&&(globalTempMusic.volume=globalTempMusic.fullVolume*e),lastLongSound&&(lastLongSound.volume=lastLongSound.fullVolume*e),lastLongSound2&&(lastLongSound2.volume=lastLongSound2.fullVolume*e)},setSoundVolume:function(e,t=0,s){var o=e.isMusic?globalMusicVol:globalVolume;e.fullVolume=t,s?PhaserScene.tweens.add({targets:e,volume:e.fullVolume*o,duration:s}):e.volume=e.fullVolume*o},swapMusic:function(e,t=AUDIO_CONSTANTS.DEFAULT_MUSIC_VOLUME,s=!0){e!==audio.getMusicName()&&(globalMusic=audio.playMusic(e,t,s))},getMusicName:function(){return globalMusic?globalMusic.key:""},fadeAway:function(e,t=AUDIO_CONSTANTS.FADE_AWAY_DURATION,s,o){let i=e.fullVolume;e.fullVolume=0,e.currTween=PhaserScene.tweens.add({targets:e,volume:0,ease:s,duration:t,onComplete:function(){e.stop(),e.fullVolume=i,o&&o()}})},fadeIn:function(e,t=1,s=AUDIO_CONSTANTS.FADE_IN_DURATION){var o=e.isMusic?globalMusicVol:globalVolume;return PhaserScene.tweens.add({delay:AUDIO_CONSTANTS.FADE_IN_DELAY,targets:e,volume:t*o,duration:s,ease:"Quad.easeIn"})}};function tweenTint(e,t,s,o="Linear",i=null){if(!e||!e.setTint)return console.warn("tweenTint: invalid image"),null;var a=e.tintTopLeft||16777215;let l={r:a>>16&255,g:a>>8&255,b:255&a};return PhaserScene.tweens.add({targets:l,r:t>>16&255,g:t>>8&255,b:255&t,duration:s,ease:o,onUpdate:()=>{e.setTint(Math.round(l.r)<<16|Math.round(l.g)<<8|Math.round(l.b))},onComplete:i})}function tweenPulse(e,t=1.2,s=300,o="Sine.easeInOut",i=null){if(!e)return null;let a=e.scaleX||1,l=e.scaleY||1;return PhaserScene.tweens.add({targets:e,scaleX:a*t,scaleY:l*t,duration:s/2,ease:o,yoyo:!0,onComplete:()=>{e.scaleX=a,e.scaleY=l,i&&i()}})}function tweenShake(e,t=6,s=400,o=null){if(!e)return null;let i=e.x;return PhaserScene.tweens.add({targets:e,x:i+t,duration:s/8,ease:"Sine.easeInOut",yoyo:!0,repeat:3,onComplete:()=>{e.x=i,o&&o()}})}function tweenBounce(e,t=20,s=500,o=null){if(!e)return null;let i=e.y;return PhaserScene.tweens.add({targets:e,y:i-t,duration:s/2,ease:"Sine.easeOut",yoyo:!0,onComplete:()=>{e.y=i,o&&o()}})}function zoomShake(e=1.015,t=null){if(!PhaserScene||!PhaserScene.cameras.main)return null;let s=PhaserScene.cameras.main;return s.setZoom(e),PhaserScene.tweens.add({targets:s,zoom:1,duration:250,ease:"Cubic.easeOut",onComplete:()=>{s.setZoom(1),t&&t()}})}class ObjectPool{constructor(e,t,s){this.factory=e,this.reset=t,this.maxSize=s||50,this.pool=[],this.activeCount=0}get(){if(0<this.pool.length){let e=this.pool.pop();return this.reset(e),this.activeCount++,e}let e=this.factory();return this.activeCount++,e}release(e){this.pool.length<this.maxSize&&this.pool.push(e),this.activeCount--}clear(){this.pool=[],this.activeCount=0}getPoolSize(){return this.pool.length}getActiveCount(){return this.activeCount}}let NORMAL="normal",HOVER="hover",PRESS="press",DISABLE="disable",ButtonState={NORMAL:"normal",HOVER:"hover",PRESS:"press",DISABLE:"disable"};class Button{constructor(e){this.scene=e.scene||PhaserScene,this.state=NORMAL,this.normal=e.normal,this.hover=e.hover||e.normal,this.press=e.press||e.normal,this.disable=e.disable||e.normal,this.onMouseDownFunc=e.onMouseDown,this.onMouseUpFunc=e.onMouseUp,this.onDragFunc=e.onDrag,this.onHoverFunc=e.onHover||null,this.onHoverOutFunc=e.onHoverOut||null,this.onDropFunc=e.onDrop||null,this.cursorInteractive=e.cursorInteractive,this.destructibles=[],this.imageRefs={},this.oldImageRef=null,this.currImageRef=null,buttonManager.addToButtonList(this),this.handlePreload(),this.setState(NORMAL),this.isDraggable=e.isDraggable||!1,this.hoverWhileDisabled=e.hoverWhileDisabled||!1,this.depth=0}setState(e){let t;switch(e){case NORMAL:t=this.normal;break;case HOVER:t=this.hover;break;case PRESS:t=this.press;break;case DISABLE:t=this.disable;break;default:return void console.error("Invalid state ",e)}if(this.state=e,t.ref){this.oldImageRef=this.currImageRef,this.currImageRef=t.ref,this.imageRefs[this.oldImageRef]&&(this.imageRefs[this.oldImageRef].visible=!1);let e=this.imageRefs[t.ref];var s;e||(e=t.atlas?this.scene.add.sprite(0,0,t.atlas,t.ref):this.scene.add.sprite(0,0,t.ref),(s=this.imageRefs[this.oldImageRef])&&(e.setOrigin(s.originX,s.originY),e.scrollFactorX=s.scrollFactorX,e.scrollFactorY=s.scrollFactorY),e.setDepth(this.depth),this.imageRefs[t.ref]=e),this.forceInvis||(e.visible=!0)}else t.ref=this.normal.ref;let o=this.imageRefs[this.oldImageRef];o=o||this.imageRefs[this.currImageRef],void 0===t.x?this.imageRefs[t.ref].x=o.x||0:(this.imageRefs[t.ref].x=t.x,this.text&&(this.text.x=this.imageRefs[t.ref].x,this.text.offsetX)&&(this.text.x+=this.text.offsetX)),void 0===t.y?this.imageRefs[t.ref].y=o.y||0:(this.imageRefs[t.ref].y=t.y,this.text&&(this.text.y=this.imageRefs[t.ref].y,this.text.offsetY)&&(this.text.y+=this.text.offsetY)),void 0===t.alpha?this.imageRefs[t.ref].alpha=o.alpha||1:(this.imageRefs[t.ref].alpha=t.alpha,this.text&&(this.text.alpha=this.imageRefs[t.ref].alpha)),void 0===t.scaleX?this.imageRefs[t.ref].scaleX=o.scaleX||1:this.imageRefs[t.ref].scaleX=t.scaleX,void 0===t.scaleY?this.imageRefs[t.ref].scaleY=o.scaleY||1:this.imageRefs[t.ref].scaleY=t.scaleY,void 0!==t.origin&&this.setOrigin(t.origin.x,t.origin.y),void 0!==t.rotation&&this.setRotation(t.rotation),void 0===t.tint?this.imageRefs[t.ref].setTint(o.tint):this.imageRefs[t.ref].setTint(t.tint)}setVisible(e=!0){e?(this.forceInvis=!1,Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].setVisible(e===this.currImageRef)})):(Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].setVisible(!1)}),this.forceInvis=!0),this.text&&this.text.setVisible(e)}checkCoordOver(e,t){var s,o,i,a;return!(this.state===DISABLE&&!this.hoverWhileDisabled||(s=void 0!==this.normal.scrollFactorX?this.normal.scrollFactorX:1,a=void 0!==this.normal.scrollFactorY?this.normal.scrollFactorY:1,e=e+PhaserScene.cameras.main.scrollX*s,s=t+PhaserScene.cameras.main.scrollY*a,a=(t=this.imageRefs[this.currImageRef]).width*Math.abs(t.scaleX),o=t.height*Math.abs(t.scaleY),i=t.x-t.originX*a,a=t.x+(1-t.originX)*a,e<i)||a<e||(i=t.y-t.originY*o,a=t.y+(1-t.originY)*o,s<i)||a<s)}onHover(){this.state===NORMAL&&this.setState(HOVER),this.onHoverFunc&&this.onHoverFunc()}onHoverOut(){this.onHoverOutFunc&&this.onHoverOutFunc(),this.state!==DISABLE&&this.setState(NORMAL)}onMouseDown(e,t){var s;this.state!==DISABLE&&(this.setState(PRESS),this.onMouseDownFunc&&this.onMouseDownFunc(e,t),this.isDraggable)&&!this.isDragged&&(this.setPos(GAME_VARS.mouseposx+PhaserScene.cameras.main.scrollX,GAME_VARS.mouseposy+PhaserScene.cameras.main.scrollY),this.isDragged=!0,(s=buttonManager.getDraggedObj())&&s.onDrop&&s.onDrop(e,t),buttonManager.setDraggedObj(this))}onDrag(e,t){this.onDragFunc&&this.onDragFunc(e,t)}clickMouseUp(){this.state!==DISABLE&&this.onMouseUpFunc&&this.onMouseUpFunc()}onMouseUp(e,t){this.state===PRESS&&(this.setState(HOVER),this.onMouseUpFunc)&&this.onMouseUpFunc(e,t)}onDrop(e,t){this.isDragged=!1,buttonManager.setDraggedObj(),this.onDropFunc&&this.onDropFunc(e,t)}setDepth(t=0){this.depth=t,this.text&&this.text.setDepth(t+1),Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].setDepth(t)})}setRotation(t){this.normal.rotation=t,this.hover.rotation=t,this.press.rotation=t,this.disable.rotation=t,Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].setRotation(t)}),this.text&&this.text.setRotation(t)}getPosX(){return this.getXPos()}getPosY(){return this.getYPos()}getScaleX(){return this.imageRefs[this.currImageRef].scaleX}getScaleY(){return this.imageRefs[this.currImageRef].scaleY}getXPos(){return this.normal.x}getYPos(){return this.normal.y}getWidth(){return this.imageRefs[this.currImageRef].width*this.imageRefs[this.currImageRef].scaleX}getHeight(){return this.imageRefs[this.currImageRef].height*this.imageRefs[this.currImageRef].scaleY}getState(){return this.state}getIsDragged(){return this.isDragged&&this.state!==DISABLE}getIsInteracted(){return this.state===HOVER||this.isDragged||this.state===PRESS}getIsHovered(){return this.state===HOVER}setOnMouseDownFunc(e){this.onMouseDownFunc=e}setOnMouseUpFunc(e){this.onMouseUpFunc=e}setOnHoverFunc(e){this.onHoverFunc=e}setOnHoverOutFunc(e){this.onHoverOutFunc=e}setNormalRef(e){this.normal.ref=e,this.state===NORMAL&&this.setState(NORMAL)}setHoverRef(e){this.hover.ref=e,this.state===HOVER&&this.setState(HOVER)}setHoverAlpha(e){this.hover.alpha=e}setPressRef(e){this.press.ref=e,this.state===PRESS&&this.setState(PRESS)}setDisableRef(e){this.disable.ref=e,this.state===DISABLE&&this.setState(DISABLE)}setAllRef(e){this.normal.ref=e,this.hover.ref=e,this.press.ref=e,this.disable.ref=e,this.setState(this.state)}setPos(t,s){void 0!==t&&(this.normal.x=t,this.hover.x=t,this.press.x=t,this.disable.x=t,Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].x=t})),void 0!==s&&(this.normal.y=s,this.hover.y=s,this.press.y=s,this.disable.y=s,Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].y=s}))}setScrollFactor(t,s){void 0!==t&&(this.normal.scrollFactorX=t,this.hover.scrollFactorX=t,this.press.scrollFactorX=t,this.disable.scrollFactorX=t,Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].scrollFactorX=t})),void 0!==s&&(this.normal.scrollFactorY=s,this.hover.scrollFactorY=s,this.press.scrollFactorY=s,this.disable.scrollFactorY=s,Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].scrollFactorY=s})),this.text&&(this.text.scrollFactorX=t,this.text.scrollFactorY=s)}setAlpha(t=1){Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].alpha=t}),this.text&&this.text.setAlpha(t)}setScale(t,s){void 0===s&&(s=t),Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].scaleX=t,this.imageRefs[e].scaleY=s})}setOrigin(t,s){return Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].setOrigin(t,s)}),this}_applyRussianTextScale(){"ru"===gameOptions.language?this.text.setScale(.72,.77):this.text.setScale(1)}addText(e,t){var s=this.normal.depth?this.normal.depth+1:1;return this.text=this.scene.add.text(this.normal.x,this.normal.y,e,t).setAlpha(this.normal.alpha).setOrigin(.5,.5).setDepth(s),this._applyRussianTextScale(),this.text}setTextColor(e){this.text&&this.text.setColor(e)}setTextOffset(e,t){this.text.offsetX=e,this.text.offsetY=t,this.text.x=this.imageRefs[this.currImageRef].x+this.text.offsetX,this.text.y=this.imageRefs[this.currImageRef].y+this.text.offsetY}setStroke(e,t){this.text&&this.text.setStroke(e,t)}getText(){return this.text}setText(e){return this.text&&this.text.setText(e),"ru"===gameOptions.language?this.text.setScale(.77,.84):this.text.setScale(1),this.text}tweenToPos(e,t,s,o,i){o={targets:this.imageRefs[this.currImageRef],ease:o,duration:s,onUpdate:i,onComplete:()=>{this.setPos(e,t)}};void 0!==e&&(o.x=e),void 0!==t&&(o.y=t),this.scene.tweens.add(o)}tweenToScale(e,t,s,o,i,a){o={targets:this.imageRefs[this.currImageRef],ease:o,easeParams:[2.5],duration:s,onUpdate:i,onComplete:()=>{this.setScale(e,t),a&&a()}};void 0!==e&&(o.scaleX=e),void 0!==t&&(o.scaleY=t),this.scene.tweens.add(o)}tweenToAlpha(e,t,s,o){var i={targets:this.imageRefs[this.currImageRef],ease:s,duration:t,alpha:e,onComplete:()=>{this.setAlpha(e),o&&o()}};this.text&&(s={targets:this.text,ease:s,duration:t,alpha:e,onComplete:()=>{this.setAlpha(e)}},this.scene.tweens.add(s)),this.scene.tweens.add(i)}handlePreload(){this.hover.preload&&this.setState(HOVER),this.press.preload&&this.setState(PRESS),this.disable.preload&&this.setState(DISABLE)}addToDestructibles(e){this.destructibles.push(e)}destroy(){if(!this.isDestroyed){if(this.isDestroyed=!0,0<this.destructibles.length)for(let e=0;e<this.destructibles.length;e++)this.destructibles[e].destroy();this.destructibles=[],buttonManager.removeButton(this),this.text&&this.text.destroy(),Object.keys(this.imageRefs).forEach(e=>{this.imageRefs[e].destroy()})}}}class InternalButtonManager{constructor(){this.buttonList=[],this.lastHovered=null,this.lastClickedButton=null,this.draggedObj=null,this.updateInterval=25,this.updateCounter=0,messageBus.subscribe("pointerUp",this.onPointerUp.bind(this)),messageBus.subscribe("pointerMove",this.onPointerMove.bind(this)),messageBus.subscribe("pointerDown",this.onPointerDown.bind(this))}update(e){var t=GAME_VARS.mouseposx,s=GAME_VARS.mouseposy;let o=null,i=null;for(let e=this.buttonList.length-1;0<=e;e--){var a=this.buttonList[e];if(a&&a.checkCoordOver(t,s)){this.lastHovered!==a&&(i=a),o=a;break}}this.lastHovered&&this.lastHovered!==o&&this.lastHovered.onHoverOut(),i&&i.onHover(),this.lastHovered=o}onPointerUp(e,t){var s=this.getLastClickedButton();s&&s.checkCoordOver(e,t)&&s.onMouseUp(e,t),this.draggedObj&&(this.draggedObj.onDrop&&this.draggedObj.onDrop(e,t),this.draggedObj=null)}onPointerMove(e,t){this.draggedObj&&(this.draggedObj.setPos(e,t),this.draggedObj.onDrag)&&this.draggedObj.onDrag(e,t)}onPointerDown(t,s){for(let e=this.buttonList.length-1;0<=e;e--){var o=this.buttonList[e];if(o.checkCoordOver(t,s)){o.onMouseDown(t,s),this.lastClickedButton=o;break}}}addToButtonList(e){this.buttonList.push(e)}getLastClickedButton(){return this.lastClickedButton}removeButton(e){e=this.buttonList.indexOf(e);-1!==e&&this.buttonList.splice(e,1)}bringButtonToTop(e){this.removeButton(e),this.addToButtonList(e)}getDraggedObj(){return this.draggedObj}setDraggedObj(e=null){this.draggedObj=e}}let buttonManager=new InternalButtonManager,helper={_typewriterTimeouts:[],runFunctionOverIntervals:function(t,s=[],o=0){if(0<s.length){let e=s[0];var i=e.delay+o,i=(o=e.duration||0,setTimeout(()=>{t(e),s.shift(),helper.runFunctionOverIntervals(t,s,o)},i));this._typewriterTimeouts.push(i)}},typewriterText:function(e,t,s=50,o){var i;t.length<=0||!e||!e.active||(e.setText(e.text+t[0]),o&&" "!==t[0]&&"â€¢"!==t[0]&&playSound(o),i=setTimeout(function(){helper.typewriterText(e,t.substring(1),s,o)}," "===t[0]?0:s),this._typewriterTimeouts.push(i))},typewriterTextByWord:function(e,o,i=50,a){if(!(o.length<=0)&&e&&e.active){var l=/[\s\-.,!?;:()\[\]{}"']/;let t=0,s=!1;for(let e=0;e<o.length;e++)if(l.test(o[e])){if(s){t=e;break}t=e+1}else s=!0;(0===t||1===t&&l.test(o[0]))&&(t=o.length);var r=o.substring(0,t),r=(e.setText(e.text+r),a&&0<r.trim().length&&playSound(a),setTimeout(function(){helper.typewriterTextByWord(e,o.substring(t),i,a)},i));this._typewriterTimeouts.push(r)}},clearTypewriterTimeouts:function(){this._typewriterTimeouts.forEach(function(e){clearTimeout(e)}),this._typewriterTimeouts=[]}};function precomputeWrapText(e,s,o,i,a={}){if(!e)return null;i="string"==typeof i?i:String(i??""),s=e.add.text(s,o,"",a);let u=a.wordWrap&&"number"==typeof a.wordWrap.width?a.wordWrap.width:null;if(u){o="function"==typeof s.style.toJSON?s.style.toJSON():{};delete o.wordWrap;let r=e.add.text(0,0,"",o).setVisible(!1);a=i.split("\n");let n=[],t=/[\u3400-\u4DBF\u4E00-\u9FFF\u3040-\u30FF\uAC00-\uD7AF]|[^\s\u3400-\u4DBF\u4E00-\u9FFF\u3040-\u30FF\uAC00-\uD7AF]+|\s+/g;a.forEach(e=>{if(""===e)n.push("");else{e=e.match(t)||[];let a="",l="";e.forEach(e=>{var t,s,o,i;/^\s+$/.test(e)?(a+=e,l+=e):(t=e.replace(/%/g,""),s=a+e,o=l+t,l=0<l.trim().length&&(i=o,r.setText(i),r.width>u)?(n.push(a.trimEnd()),a=e,t):(a=s,o))}),n.push(a.trimEnd())}}),r.destroy(),s.setText(n.join("\n"))}else s.setText(i);return s}Object.assign(helper,{clickEffectPool:null,initClickEffectPool:function(e){helper.clickEffectPool=new ObjectPool(function(){return e.add.image(0,0,"white_pixel")},function(e){e.setActive(!1),e.setVisible(!1),e.setScale(1),e.setAlpha(.6),e.setDepth(1e4)},50)},createClickEffect:function(e,t){let s;helper.clickEffectPool&&0<helper.clickEffectPool.getPoolSize()?((s=helper.clickEffectPool.get()).setPosition(e,t),s.setActive(!0),s.setVisible(!0)):((s=PhaserScene.add.image(e,t,"white_pixel")).setAlpha(.6),s.setDepth(1e4),s.setScale(7));PhaserScene.tweens.add({targets:s,scaleX:11,scaleY:11,duration:50,ease:"Quad.easeIn",onComplete:function(){PhaserScene.tweens.add({targets:s,scaleX:0,scaleY:0,duration:250,ease:"Quad.easeOut",onComplete:function(){helper.clickEffectPool&&helper.clickEffectPool.getPoolSize()<50?helper.clickEffectPool.release(s):s.destroy()}})}})}}),Object.assign(helper,{openFullscreen:function(){var e=document.body;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},testMobile:function(){return/Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},isSafariIOS:function(){var e=window.navigator.userAgent,t=!!e.match(/iPad/i)||!!e.match(/iPhone/i),s=!!e.match(/WebKit/i);return t&&s&&!e.match(/CriOS/i)},createGlobalClickBlocker:function(e){return globalObjects.clickBlocker?(globalObjects.clickBlocker.setState(NORMAL),globalObjects.clickBlocker.setOnMouseUpFunc(function(){}),buttonManager.bringButtonToTop(globalObjects.clickBlocker)):globalObjects.clickBlocker=new Button({normal:{ref:"black_pixel",x:GAME_CONSTANTS.halfWidth,y:GAME_CONSTANTS.halfHeight,alpha:.001,scaleX:1e3,scaleY:1e3},onMouseUp:function(){}}),e&&(e=PhaserScene.sys.canvas)&&(e.style.cursor="pointer"),globalObjects.clickBlocker},hideGlobalClickBlocker:function(){var e;globalObjects.clickBlocker&&(globalObjects.clickBlocker.setState(DISABLE),e=PhaserScene.sys.canvas)&&(e.style.cursor="default")},restartGame:function(){location.reload()}});class TimeManager{constructor(){messageBus.subscribe("tempPause",this.setTempPause.bind(this)),messageBus.subscribe("pauseGame",this.setPermPause.bind(this)),messageBus.subscribe("setGameSlow",this.setGameSlow.bind(this)),messageBus.subscribe("clearGameSlow",this.clearGameSlow.bind(this)),messageBus.subscribe("unpauseGame",this.setUnpause.bind(this))}setTempPause(e=100,t){GAME_VARS.timeScale=t||.5,PhaserScene.tweens.timeScale=t||.6,PhaserScene.time.timeScale=t||.5,PhaserScene.anims.globalTimeScale=t||.6,this.currTimeoutAmt&&GAME_VARS.timeScale>this.currTimeoutAmt||(this.currTimeoutAmt=GAME_VARS.timeScale,this.currTimeoutPause&&clearTimeout(this.currTimeoutPause),this.currTimeoutPause=setTimeout(()=>{GAME_VARS.timeScale=GAME_VARS.gameManualSlowSpeed||1,PhaserScene.tweens.timeScale=GAME_VARS.gameManualSlowSpeed||1,PhaserScene.time.timeScale=GAME_VARS.gameManualSlowSpeed||1,PhaserScene.anims.globalTimeScale=GAME_VARS.gameManualSlowSpeed||1,this.currTimeoutAmt=null},e))}setPermPause(e=.002){GAME_VARS.permTimeScale=e,GAME_VARS.timeScale=e,PhaserScene.tweens.timeScale=e,PhaserScene.time.timeScale=e,PhaserScene.anims.globalTimeScale=e}setUnpause(){GAME_VARS.timeScale=GAME_VARS.gameManualSlowSpeed||1,GAME_VARS.permTimeScale=GAME_VARS.timeScale,PhaserScene.tweens.timeScale=GAME_VARS.gameManualSlowSpeed||1,PhaserScene.time.timeScale=GAME_VARS.gameManualSlowSpeed||1,PhaserScene.anims.globalTimeScale=GAME_VARS.gameManualSlowSpeed||1}setGameSlow(e){GAME_VARS.gameManualSlowSpeed=e,GAME_VARS.gameManualSlowSpeedInverse=1/GAME_VARS.gameManualSlowSpeed,GAME_VARS.timeScale=GAME_VARS.gameManualSlowSpeed,PhaserScene.tweens.timeScale=GAME_VARS.gameManualSlowSpeed,PhaserScene.time.timeScale=GAME_VARS.gameManualSlowSpeed,PhaserScene.anims.globalTimeScale=GAME_VARS.gameManualSlowSpeed}clearGameSlow(){GAME_VARS.gameManualSlowSpeed=1,GAME_VARS.gameManualSlowSpeedInverse=1,GAME_VARS.timeScale=GAME_VARS.gameManualSlowSpeed,PhaserScene.tweens.timeScale=GAME_VARS.gameManualSlowSpeed,PhaserScene.time.timeScale=GAME_VARS.gameManualSlowSpeed,PhaserScene.anims.globalTimeScale=GAME_VARS.gameManualSlowSpeed}}class UpdateManager{constructor(){this.listOfFunctions=[]}update(t){if(!(GAME_VARS.timeScale<.01))for(let e=0;e<this.listOfFunctions.length;e++)this.listOfFunctions[e](t)}addFunction(t){for(let e=0;e<this.listOfFunctions.length;e++)if(t===this.listOfFunctions[e])return;return this.listOfFunctions.push(t),t}removeFunction(t){for(let e=0;e<this.listOfFunctions.length;e++)t===this.listOfFunctions[e]&&this.listOfFunctions.splice(e,1)}}let updateManager=new UpdateManager,_POPUP={DEPTH:111e3,OVERLAY_DEPTH:110900,W:460,H:200,BTN_H:42,BTN_W:140,BTN_GAP:20,FONT_TITLE:24,FONT_BODY:19,FONT_BTN:18,FONT_YN:28,FONT_YN_TITLE:30,FONT_YN_BODY:24};function _createDarkOverlay(e){var t=e.ref||"black_pixel",s=e.scaleX||500,o=e.scaleY||s,i=void 0!==e.targetAlpha?e.targetAlpha:.75,a=void 0!==e.duration?e.duration:60,t=PhaserScene.add.image(GAME_CONSTANTS.halfWidth,GAME_CONSTANTS.halfHeight,t).setScale(s,o).setDepth(e.depth).setAlpha(0);return void 0!==e.tint&&t.setTint(e.tint),PhaserScene.tweens.add({targets:t,alpha:i,ease:"Cubic.easeOut",duration:a}),t}function _createFullscreenBlocker(e){var t=new Button({normal:{ref:"white_pixel",x:GAME_CONSTANTS.halfWidth,y:GAME_CONSTANTS.halfHeight,scaleX:GAME_CONSTANTS.WIDTH,scaleY:GAME_CONSTANTS.HEIGHT,alpha:.001,tint:0},onMouseUp:()=>{}});return t.setDepth(e),t}function showPopup({title:e="",body:t="",buttons:s=[],depth:a=_POPUP.DEPTH,fast:o=!1}={}){var i=GAME_CONSTANTS.halfWidth,l=GAME_CONSTANTS.halfHeight;let r=_createDarkOverlay({ref:"white_pixel",scaleX:GAME_CONSTANTS.WIDTH,scaleY:GAME_CONSTANTS.HEIGHT,tint:0,depth:a,targetAlpha:.75,duration:o?1:60}),n=_createFullscreenBlocker(a),u=PhaserScene.add.image(i,l-10,"white_pixel").setScale(_POPUP.W,_POPUP.H).setTint(1710638).setAlpha(0).setDepth(a+1),c=(PhaserScene.tweens.add({targets:u,alpha:1,ease:"Back.easeOut",duration:o?1:220}),PhaserScene.add.text(i,l-10-.5*_POPUP.H+32,e,{fontFamily:"Arial",fontSize:_POPUP.FONT_TITLE,color:"#ffffff",fontStyle:"bold",align:"center"}).setOrigin(.5,.5).setDepth(a+2).setAlpha(0)),h=PhaserScene.add.text(i,l-10,t,{fontFamily:"Arial",fontSize:_POPUP.FONT_BODY,color:"#cccccc",align:"center",wordWrap:{width:_POPUP.W-48}}).setOrigin(.5,.5).setDepth(a+2).setAlpha(0),d=(PhaserScene.tweens.add({targets:[c,h],alpha:1,ease:"Cubic.easeOut",duration:o?1:220}),[]);function g(){r.destroy(),u.destroy(),c.destroy(),h.destroy(),n.destroy(),d.forEach(e=>e.destroy())}e=s.length;let f=i-(e*_POPUP.BTN_W+(e-1)*_POPUP.BTN_GAP)/2+_POPUP.BTN_W/2,m=l+70;return s.forEach((e,t)=>{var t=f+t*(_POPUP.BTN_W+_POPUP.BTN_GAP),s=e.primary?2904706:2963272,o=e.primary?3828648:4871528,i=e.primary?1717601:1712172,t=new Button({normal:{ref:"white_pixel",x:t,y:m,scaleX:_POPUP.BTN_W,scaleY:_POPUP.BTN_H,tint:s},hover:{tint:o},press:{tint:i},disable:{alpha:0},onMouseUp:()=>{g(),e.onClick&&e.onClick()}});t.setDepth(a+2),t.addText(e.text,{fontFamily:"Arial",fontSize:_POPUP.FONT_BTN,color:"#ffffff",align:"center"}),d.push(t)}),g}function showNineSlicePopup({title:e="",body:t="",buttons:s=[],texture:o="popup.png",atlas:i="buttons",cornerSize:a=50,width:l=460,height:r=200,depth:n=_POPUP.DEPTH,fast:u=!1}={}){var c=GAME_CONSTANTS.halfWidth,h=GAME_CONSTANTS.halfHeight;let d=_createDarkOverlay({ref:"white_pixel",scaleX:GAME_CONSTANTS.WIDTH,scaleY:GAME_CONSTANTS.HEIGHT,tint:0,depth:n,targetAlpha:.75,duration:u?1:60}),g=_createFullscreenBlocker(n),f=PhaserScene.add.nineslice(c,h-10,i,o,l,r,a,a,a,a),m=(f.setDepth(n+1).setAlpha(0),PhaserScene.tweens.add({targets:f,alpha:1,ease:"Back.easeOut",duration:u?1:220}),PhaserScene.add.text(c,h-10-.5*r+32,e,{fontFamily:"Arial",fontSize:_POPUP.FONT_TITLE,color:"#ffffff",fontStyle:"bold",align:"center"}).setOrigin(.5,.5).setDepth(n+2).setAlpha(0)),p=PhaserScene.add.text(c,h-10,t,{fontFamily:"Arial",fontSize:_POPUP.FONT_BODY,color:"#cccccc",align:"center",wordWrap:{width:l-48}}).setOrigin(.5,.5).setDepth(n+2).setAlpha(0),S=(PhaserScene.tweens.add({targets:[m,p],alpha:1,ease:"Cubic.easeOut",duration:u?1:220}),[]);function b(){d.destroy(),f.destroy(),m.destroy(),p.destroy(),g.destroy(),S.forEach(e=>e.destroy())}i=s.length;let M=c-(i*_POPUP.BTN_W+(i-1)*_POPUP.BTN_GAP)/2+_POPUP.BTN_W/2,A=h+70;return s.forEach((e,t)=>{var t=M+t*(_POPUP.BTN_W+_POPUP.BTN_GAP),s=e.primary?2904706:2963272,o=e.primary?3828648:4871528,i=e.primary?1717601:1712172,t=new Button({normal:{ref:"white_pixel",x:t,y:A,scaleX:_POPUP.BTN_W,scaleY:_POPUP.BTN_H,tint:s},hover:{tint:o},press:{tint:i},disable:{alpha:0},onMouseUp:()=>{b(),e.onClick&&e.onClick()}});t.setDepth(n+2),t.addText(e.text,{fontFamily:"Arial",fontSize:_POPUP.FONT_BTN,color:"#ffffff",align:"center"}),S.push(t)}),b}function showYesNoPopup(e,t,s="...",o="...",i=()=>{},a=!1){var l=a?.2:50;let r=_createDarkOverlay({ref:"black_pixel",scaleX:500,depth:_POPUP.OVERLAY_DEPTH,targetAlpha:.75,duration:l}),n=_createFullscreenBlocker(_POPUP.OVERLAY_DEPTH),u=PhaserScene.add.image(GAME_CONSTANTS.halfWidth,GAME_CONSTANTS.halfHeight-40,"ui","paper_half.png").setDepth(_POPUP.DEPTH).setScale(.7,.58),c=PhaserScene.add.text(GAME_CONSTANTS.halfWidth,u.y-75,s,{fontFamily:"Arial",fontSize:_POPUP.FONT_YN_TITLE,color:"#000000",align:"center"}).setOrigin(.5,.5).setDepth(_POPUP.DEPTH).setAlpha(.1),h=PhaserScene.add.text(GAME_CONSTANTS.halfWidth,u.y-17,o,{fontFamily:"Arial",fontSize:_POPUP.FONT_YN_BODY,color:"#000000",align:"center"}).setOrigin(.5,.5).setDepth(_POPUP.DEPTH).setAlpha(.1);l=a?.7:200;PhaserScene.tweens.add({targets:[c,h],alpha:1,ease:"Cubic.easeOut",duration:l}),PhaserScene.tweens.add({targets:u,scaleX:.72,scaleY:.6,ease:"Back.easeOut",duration:l});let d=PhaserScene.sys.canvas,g,f,m=e=>e.forEach(e=>{e&&e.destroy()}),p=new Button({normal:{ref:"menu_btn_normal.png",atlas:"buttons",x:GAME_CONSTANTS.halfWidth+128,y:u.y+55},hover:{ref:"menu_btn_hover.png",atlas:"buttons"},press:{ref:"menu_btn_hover.png",atlas:"buttons"},disable:{alpha:0},onHover:()=>{d&&(d.style.cursor="pointer")},onHoverOut:()=>{d&&(d.style.cursor="default")},onMouseUp:()=>{m([f,g,p,r,n,c,h,u]),i()}}),S=(p.setOrigin(.5,.5),p.addText(e,{fontFamily:"Arial",fontSize:_POPUP.FONT_YN,color:"#000000",align:"center"}),p.setDepth(_POPUP.DEPTH),p.setScale(.7),(f=new Button({normal:{ref:"closebtn.png",atlas:"buttons",alpha:.95,x:GAME_CONSTANTS.halfWidth+190,y:u.y-95},hover:{ref:"closebtn_hover.png",atlas:"buttons",alpha:1},press:{ref:"closebtn_press.png",atlas:"buttons",alpha:1},disable:{ref:"closebtn.png",atlas:"buttons",alpha:0},onHover:()=>{d&&(d.style.cursor="pointer")},onHoverOut:()=>{d&&(d.style.cursor="default")},onMouseUp:()=>{m([f,g,p,r,n,c,h,u])}})).setOrigin(.5,.5),f.setDepth(_POPUP.DEPTH),[f,null,p,r,n,c,h,u]);return g=new Button({normal:{ref:"menu_btn2_normal.png",atlas:"buttons",x:GAME_CONSTANTS.halfWidth-128,y:u.y+55},hover:{ref:"menu_btn2_hover.png",atlas:"buttons"},press:{ref:"menu_btn2_hover.png",atlas:"buttons"},disable:{alpha:0},onHover:()=>{d&&(d.style.cursor="pointer")},onHoverOut:()=>{d&&(d.style.cursor="default")},onMouseUp:()=>{S[1]=g,m(S)}}),(S[1]=g).setOrigin(.5,.5),g.addText(t,{fontFamily:"Arial",fontSize:_POPUP.FONT_YN,color:"#000000",align:"center"}),g.setDepth(_POPUP.DEPTH),g.setScale(.7),S}let createVirtualGroup=(r,e=0,t=0)=>{let n=[],u=e,c=t,s={add:e=>(n.push({ref:e,offsetX:e.x-u,offsetY:e.y-c}),e),setAlpha:t=>(n.forEach(e=>{e.ref.scene&&(e.ref.alpha=t)}),s),tweenAlpha:(e,t={})=>{var s=n.filter(e=>e.ref.scene).map(e=>e.ref);0<s.length&&r.tweens.add({targets:s,alpha:e,...t})},removeChild:t=>{n=n.filter(e=>e.ref!==t)},removeAllChildren:()=>{n=[]},destroy:()=>{n.forEach(e=>{e.ref&&e.ref.destroy&&e.ref.destroy()}),n=[]},set x(e){u=e,n.forEach(e=>{e.ref.scene&&e.ref.setPosition(u+e.offsetX,e.ref.y)})},get x(){return u},set y(e){c=e,n.forEach(e=>{e.ref.scene&&e.ref.setPosition(e.ref.x,c+e.offsetY)})},get y(){return c},setPosition:(e,t)=>{u=e,c=t,n.forEach(e=>{e.ref.scene&&e.ref.setPosition(u+e.offsetX,c+e.offsetY)})},tweenBy:(s,o,e={})=>{let i=u,a=c;r.tweens.add({targets:{progress:0},progress:1,...e,onUpdate:(e,t)=>{u=i+s*t.progress,c=a+o*t.progress,n.forEach(e=>{e.ref.scene&&e.ref.setPosition(u+e.offsetX,c+e.offsetY)})}})},tweenTo:(e,t,s={})=>{let o=u,i=c,a=e-o,l=t-i;r.tweens.add({targets:{progress:0},progress:1,...s,onUpdate:(e,t)=>{u=o+a*t.progress,c=i+l*t.progress,n.forEach(e=>{e.ref.scene&&e.ref.setPosition(u+e.offsetX,c+e.offsetY)})}})}};return s};